/*!
 * @githubjs/github-trending v1.1.6
 * (c) 2014-2020 Ying Wang <upcwangying@gmail.com> (https://github.com/upcwangying)
 * Released under the MIT License.
 */
"use strict";const e=require("request-promise"),l=require("cheerio"),n=require("./constant/trending-since"),t=require("./constant/trending-type"),{TrendingRepository:r,PrimaryLanguage:i,RepositoryBuildBy:a,TrendingDeveloper:o,PopularRepository:s}=require("./model/index.js"),c="https://github.com",u={uri:`${c}/trending`,transform:e=>l.load(e)};module.exports={TrendingRepository:r,PrimaryLanguage:i,RepositoryBuildBy:a,TrendingDeveloper:o,PopularRepository:s,TrendingSince:n,TrendingType:t,getTrendingRepositories:({since:l,language:n}={})=>new Promise((t,o)=>{let s=`${c}/trending`;n&&(s+=`/${n}`),l&&(s+=`?since=${l}`),e({...u,uri:s}).then(e=>{if(!e)return void o("response is null!");const l=[];e(".Box-row").each((n,t)=>{const o=e(".repo-language-color",t);let s;if(null!=o){const l=new RegExp("#[0-9a-fA-F]{3,6}").exec(e(o).attr("style")),n=e(o).next(),t=null==n||null==n.html()?null:n.html();s=new i({name:null==t?null:t.trim(),color:null==l?null:l[0]})}const u=e(".f6 .muted-link .octicon-star",t);let p;null!=u&&(p=e(u).parent().html().replace(/^[\s\S]*svg>/g,"").replace(/,/g,""));const g=null==p?null:parseInt(p.trim(),10),m=e(".f6 .octicon-repo-forked",t);let d;null!=m&&(d=e(m).parent().html().replace(/^[\s\S]*svg>/g,"").replace(/,/g,""));const h=null==d?null:parseInt(d.trim(),10),v=e(".float-sm-right",t);let y,f,x;null!=v&&(y=e(v).html().replace(/^[\s\S]*svg>/g,"").replace(/,/g,"").trim());const w=e("p",t);let $=null==w?null:w.html();$=null==$?null:$.trim(),null!=$&&(f=$.replace(/<g-emoji.*?>/g,"").replace(/<\/g-emoji>/g,"").replace(/<a.*?>/g,"").replace(/<\/a>/g,"").trim(),x=`<div>${$}</div>`);const R=[],T=e(".avatar",t);null!=T&&T.length>0&&T.each((l,n)=>{R.push(new a({avatar:e(n).attr("src"),username:e(n).attr("alt").replace(/@/g,"")}))});const B=e(".text-normal",t);let q;B&&(q=B.html().replace("/","").trim());const P=e(".text-normal",t);let j;P&&(j=P.parent().html().replace(/[\s\S]*span>/g,"").trim()),l.push(new r({owner:q,avatar:`${c}/${q}.png`,name:j,description:f,descriptionHTML:x,starCount:g,forkCount:h,stars:y,primaryLanguage:s,buildBys:R}))}),t(l)}).catch(e=>{o(e)})}),getTrendingDevelopers:({since:l,language:n}={})=>new Promise((t,r)=>{let i=`${c}/trending/developers`;n&&(i+=`/${n}`),l&&(i+=`?since=${l}`),e({...u,uri:i}).then(e=>{if(!e)return void r("response is null!");const l=[];e(".Box-row").each((n,t)=>{let r;const i=e(".d-sm-flex .col-md-6",t),a=null==i?null:i.last();if(null!=a){let l,n;const t=e(".mt-1",a);let i=null==t?null:t.html();i=null==i?null:i.trim(),null!=i&&(l=i.replace(/<g-emoji.*?>/g,"").replace(/<\/g-emoji>/g,"").replace(/<a.*?>/g,"").replace(/<\/a>/g,"").trim(),n=`<div>${i}</div>`);const o=e("div>article>h1>a",a),c=null==o?null:e(o).attr("href");let u;o&&(u=e(o).text().trim()),r=new s({url:c,name:u,description:l,descriptionRawHtml:n})}const c=e(".rounded-1",t),u=e(".link-gray",t),p=e(".d-md-flex",t);let g,m,d;c&&(g=e(c).attr("src").trim()),u&&(m=e(u).html().trim()),p&&(d=e(".lh-condensed",p).children().first().text().trim()),l.push(new o({avatar:g,username:m,nickname:d,popularRepository:r}))}),t(l)}).catch(e=>{r(e)})})};
