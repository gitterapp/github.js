/*!
 * @githubjs/github-trending v1.1.6
 * (c) 2014-2020 Ying Wang <upcwangying@gmail.com> (https://github.com/upcwangying)
 * Released under the MIT License.
 */
const e=require("request-promise"),l=require("cheerio"),n=require("./constant/trending-since"),r=require("./constant/trending-type"),{TrendingRepository:t,PrimaryLanguage:i,RepositoryBuildBy:a,TrendingDeveloper:o,PopularRepository:s}=require("./model/index.js"),c="https://github.com",u={uri:`${c}/trending`,transform:e=>l.load(e)};module.exports={TrendingRepository:t,PrimaryLanguage:i,RepositoryBuildBy:a,TrendingDeveloper:o,PopularRepository:s,TrendingSince:n,TrendingType:r,getTrendingRepositories:({since:l,language:n}={})=>new Promise((r,o)=>{let s=`${c}/trending`;n&&(s+=`/${n}`),l&&(s+=`?since=${l}`),e({...u,uri:s}).then(e=>{if(!e)return void o("response is null!");const l=[];e(".Box-row").each((n,r)=>{const o=e(".repo-language-color",r);let s;if(null!=o){const l=new RegExp("#[0-9a-fA-F]{3,6}").exec(e(o).attr("style")),n=e(o).next(),r=null==n||null==n.html()?null:n.html();s=new i({name:null==r?null:r.trim(),color:null==l?null:l[0]})}const u=e(".f6 .muted-link .octicon-star",r);let p;null!=u&&(p=e(u).parent().html().replace(/^[\s\S]*svg>/g,"").replace(/,/g,""));const g=null==p?null:parseInt(p.trim(),10),m=e(".f6 .octicon-repo-forked",r);let d;null!=m&&(d=e(m).parent().html().replace(/^[\s\S]*svg>/g,"").replace(/,/g,""));const h=null==d?null:parseInt(d.trim(),10),v=e(".float-sm-right",r);let y,f,x;null!=v&&(y=e(v).html().replace(/^[\s\S]*svg>/g,"").replace(/,/g,"").trim());const w=e("p",r);let $=null==w?null:w.html();$=null==$?null:$.trim(),null!=$&&(f=$.replace(/<g-emoji.*?>/g,"").replace(/<\/g-emoji>/g,"").replace(/<a.*?>/g,"").replace(/<\/a>/g,"").trim(),x=`<div>${$}</div>`);const R=[],T=e(".avatar",r);null!=T&&T.length>0&&T.each((l,n)=>{R.push(new a({avatar:e(n).attr("src"),username:e(n).attr("alt").replace(/@/g,"")}))});const B=e(".text-normal",r);let q;B&&(q=B.html().replace("/","").trim());const P=e(".text-normal",r);let j;P&&(j=P.parent().html().replace(/[\s\S]*span>/g,"").trim()),l.push(new t({owner:q,avatar:`${c}/${q}.png`,name:j,description:f,descriptionHTML:x,starCount:g,forkCount:h,stars:y,primaryLanguage:s,buildBys:R}))}),r(l)}).catch(e=>{o(e)})}),getTrendingDevelopers:({since:l,language:n}={})=>new Promise((r,t)=>{let i=`${c}/trending/developers`;n&&(i+=`/${n}`),l&&(i+=`?since=${l}`),e({...u,uri:i}).then(e=>{if(!e)return void t("response is null!");const l=[];e(".Box-row").each((n,r)=>{let t;const i=e(".d-sm-flex .col-md-6",r),a=null==i?null:i.last();if(null!=a){let l,n;const r=e(".mt-1",a);let i=null==r?null:r.html();i=null==i?null:i.trim(),null!=i&&(l=i.replace(/<g-emoji.*?>/g,"").replace(/<\/g-emoji>/g,"").replace(/<a.*?>/g,"").replace(/<\/a>/g,"").trim(),n=`<div>${i}</div>`);const o=e("div>article>h1>a",a),c=null==o?null:e(o).attr("href");let u;o&&(u=e(o).text().trim()),t=new s({url:c,name:u,description:l,descriptionRawHtml:n})}const c=e(".rounded-1",r),u=e(".link-gray",r),p=e(".d-md-flex",r);let g,m,d;c&&(g=e(c).attr("src").trim()),u&&(m=e(u).html().trim()),p&&(d=e(".lh-condensed",p).children().first().text().trim()),l.push(new o({avatar:g,username:m,nickname:d,popularRepository:t}))}),r(l)}).catch(e=>{t(e)})})};
